name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Create GitHub Release with Changelog
        run: npx changelogithub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS
    needs: create-release
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Update version in Info.plist
        run: |
          VERSION="${GITHUB_REF_NAME#v}"  # Remove 'v' prefix (v1.2.4 -> 1.2.4)
          BUILD_NUMBER=$(git rev-list --count HEAD)

          # Update CFBundleShortVersionString
          sed -i '' "s/<string>.*<\/string><!--VERSION-->/<string>${VERSION}<\/string><!--VERSION-->/" Resources/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${VERSION}" Resources/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${BUILD_NUMBER}" Resources/Info.plist

          echo "Updated version to ${VERSION} (build ${BUILD_NUMBER})"

      - name: Create DMG (arm64)
        run: |
          APP_NAME="PortKiller"
          VERSION="${GITHUB_REF_NAME}"
          DMG_NAME_ARM64="${APP_NAME}-${VERSION}-arm64.dmg"

          # Build arm64 app
          ./scripts/build-app.sh arm64

          # Create temporary directory for DMG contents
          mkdir -p dmg_contents_arm64
          # Use ditto to preserve symlinks and extended attributes
          ditto .build/arm64-apple-macosx/release/PortKiller.app dmg_contents_arm64/PortKiller.app

          # Create Applications symlink
          ln -s /Applications dmg_contents_arm64/Applications

          # Create DMG
          hdiutil create -volname "$APP_NAME" \
            -srcfolder dmg_contents_arm64 \
            -ov -format UDZO \
            "$DMG_NAME_ARM64"

          # Cleanup
          rm -rf dmg_contents_arm64

          echo "DMG_NAME_ARM64=$DMG_NAME_ARM64" >> $GITHUB_ENV

      - name: Create DMG (x86_64)
        run: |
          APP_NAME="PortKiller"
          VERSION="${GITHUB_REF_NAME}"
          DMG_NAME_X64="${APP_NAME}-${VERSION}-x64.dmg"

          # Build x86_64 app
          # Clean previous build to ensure architecture isolation
          rm -rf .build/release/PortKiller.app
          ./scripts/build-app.sh x86_64

          # Create temporary directory for DMG contents
          mkdir -p dmg_contents_x64
          # Use ditto to preserve symlinks and extended attributes
          ditto .build/x86_64-apple-macosx/release/PortKiller.app dmg_contents_x64/PortKiller.app

          # Create Applications symlink
          ln -s /Applications dmg_contents_x64/Applications

          # Create DMG
          hdiutil create -volname "$APP_NAME" \
            -srcfolder dmg_contents_x64 \
            -ov -format UDZO \
            "$DMG_NAME_X64"

          # Cleanup
          rm -rf dmg_contents_x64

          echo "DMG_NAME_X64=$DMG_NAME_X64" >> $GITHUB_ENV

      - name: Sign DMGs
        env:
          DEVELOPER_ID_NAME: ${{ secrets.DEVELOPER_ID_NAME }}
        run: |
          codesign --force --sign "$DEVELOPER_ID_NAME" --timestamp "$DMG_NAME_ARM64"
          codesign --force --sign "$DEVELOPER_ID_NAME" --timestamp "$DMG_NAME_X64"

      - name: Notarize DMGs
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Notarize arm64 DMG
          SUBMIT_OUTPUT_ARM=$(xcrun notarytool submit "$DMG_NAME_ARM64" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait 2>&1) || true
          
          echo "ARM64 Notarization: $SUBMIT_OUTPUT_ARM"

          if echo "$SUBMIT_OUTPUT_ARM" | grep -q "Accepted"; then
            xcrun stapler staple "$DMG_NAME_ARM64" || echo "Stapling arm64 failed but continuing..."
          fi

          # Notarize x64 DMG
          SUBMIT_OUTPUT_X64=$(xcrun notarytool submit "$DMG_NAME_X64" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait 2>&1) || true
          
          echo "x86_64 Notarization: $SUBMIT_OUTPUT_X64"

          if echo "$SUBMIT_OUTPUT_X64" | grep -q "Accepted"; then
            xcrun stapler staple "$DMG_NAME_X64" || echo "Stapling x64 failed but continuing..."
          fi

      - name: Generate Sparkle EdDSA signatures
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Download Sparkle tools
          curl -L -o sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz"
          mkdir -p sparkle_tools
          tar -xf sparkle.tar.xz -C sparkle_tools

          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key
          
          # Generate signature for arm64
          SIGN_OUTPUT_ARM=$(sparkle_tools/bin/sign_update "$DMG_NAME_ARM64" -f /tmp/sparkle_private_key)
          SIGNATURE_ARM=$(echo "$SIGN_OUTPUT_ARM" | grep -o 'edSignature="[^"]*"' | sed 's/edSignature="//;s/"$//')
          echo "SPARKLE_SIGNATURE_ARM=$SIGNATURE_ARM" >> $GITHUB_ENV
          
          # Generate signature for x64
          SIGN_OUTPUT_X64=$(sparkle_tools/bin/sign_update "$DMG_NAME_X64" -f /tmp/sparkle_private_key)
          SIGNATURE_X64=$(echo "$SIGN_OUTPUT_X64" | grep -o 'edSignature="[^"]*"' | sed 's/edSignature="//;s/"$//')
          echo "SPARKLE_SIGNATURE_X64=$SIGNATURE_X64" >> $GITHUB_ENV
          
          rm /tmp/sparkle_private_key

      - name: Upload DMGs to Release
        run: |
          gh release upload ${{ github.ref_name }} "$DMG_NAME_ARM64" --clobber
          gh release upload ${{ github.ref_name }} "$DMG_NAME_X64" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Update appcast.xml
        run: |
          VERSION="${GITHUB_REF_NAME#v}"  # Remove 'v' prefix (v1.2.7 -> 1.2.7)
          BUILD_NUMBER=$(git rev-list --count HEAD)  # Same as CFBundleVersion in app
          
          # Use arm64 by default for now (can expand to multi-item feed later)
          DMG_SIZE_ARM=$(stat -f%z "$DMG_NAME_ARM64")
          DMG_URL_ARM="https://github.com/productdevbook/port-killer/releases/download/${GITHUB_REF_NAME}/${DMG_NAME_ARM64}"
          
          DMG_SIZE_X64=$(stat -f%z "$DMG_NAME_X64")
          DMG_URL_X64="https://github.com/productdevbook/port-killer/releases/download/${GITHUB_REF_NAME}/${DMG_NAME_X64}"

          echo "Version: $VERSION, Build: $BUILD_NUMBER"

          # Create or update appcast.xml
          # We add two items: one for arm64 (Apple Silicon) and one for x86_64 (Intel)
          cat > appcast.xml << 'APPCAST_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>PortKiller Updates</title>
              <link>https://github.com/productdevbook/port-killer</link>
              <description>Most recent updates to PortKiller</description>
              <language>en</language>
              <item>
                <title>Version VERSIONPLACEHOLDER (Apple Silicon)</title>
                <pubDate>DATEPLACEHOLDER</pubDate>
                <sparkle:version>BUILDPLACEHOLDER</sparkle:version>
                <sparkle:shortVersionString>VERSIONPLACEHOLDER</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
                <enclosure
                  url="URLPLACEHOLDER_ARM"
                  length="SIZEPLACEHOLDER_ARM"
                  type="application/octet-stream"
                  sparkle:edSignature="SIGPLACEHOLDER_ARM"
                  sparkle:os="macos"
                  sparkle:cpu="arm64" />
              </item>
              <item>
                <title>Version VERSIONPLACEHOLDER (Intel)</title>
                <pubDate>DATEPLACEHOLDER</pubDate>
                <sparkle:version>BUILDPLACEHOLDER</sparkle:version>
                <sparkle:shortVersionString>VERSIONPLACEHOLDER</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
                <enclosure
                  url="URLPLACEHOLDER_X64"
                  length="SIZEPLACEHOLDER_X64"
                  type="application/octet-stream"
                  sparkle:edSignature="SIGPLACEHOLDER_X64"
                  sparkle:os="macos"
                  sparkle:cpu="x86_64" />
              </item>
            </channel>
          </rss>
          APPCAST_EOF

          # Replace placeholders
          sed -i '' "s|BUILDPLACEHOLDER|${BUILD_NUMBER}|g" appcast.xml
          sed -i '' "s|VERSIONPLACEHOLDER|${VERSION}|g" appcast.xml
          sed -i '' "s|DATEPLACEHOLDER|$(date -R)|g" appcast.xml
          
          # Replace ARM64 placeholders
          sed -i '' "s|URLPLACEHOLDER_ARM|${DMG_URL_ARM}|g" appcast.xml
          sed -i '' "s|SIZEPLACEHOLDER_ARM|${DMG_SIZE_ARM}|g" appcast.xml
          sed -i '' "s|SIGPLACEHOLDER_ARM|${SPARKLE_SIGNATURE_ARM}|g" appcast.xml
          
          # Replace X64 placeholders
          sed -i '' "s|URLPLACEHOLDER_X64|${DMG_URL_X64}|g" appcast.xml
          sed -i '' "s|SIZEPLACEHOLDER_X64|${DMG_SIZE_X64}|g" appcast.xml
          sed -i '' "s|SIGPLACEHOLDER_X64|${SPARKLE_SIGNATURE_X64}|g" appcast.xml

      - name: Commit appcast.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git add appcast.xml
          git commit -m "chore: update appcast.xml for ${GITHUB_REF_NAME}" || echo "No changes to commit"
          git push origin main

      - name: Update Homebrew Tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          
          # Get SHA256 of the DMGs
          SHA256_ARM=$(shasum -a 256 "$DMG_NAME_ARM64" | cut -d' ' -f1)
          SHA256_X64=$(shasum -a 256 "$DMG_NAME_X64" | cut -d' ' -f1)

          # Clone homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/productdevbook/homebrew-tap.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap

          # Update cask formula to support both architectures
          cat > Casks/portkiller.rb << EOF
          cask "portkiller" do
            version "${VERSION}"
            
            if Hardware::CPU.intel?
              sha256 "${SHA256_X64}"
              url "https://github.com/productdevbook/port-killer/releases/download/v#{version}/PortKiller-v#{version}-x64.dmg"
            else
              sha256 "${SHA256_ARM}"
              url "https://github.com/productdevbook/port-killer/releases/download/v#{version}/PortKiller-v#{version}-arm64.dmg"
            end

            name "PortKiller"
            desc "Menu bar app to find and kill processes running on open ports"
            homepage "https://github.com/productdevbook/port-killer"

            depends_on macos: ">= :sequoia"

            app "PortKiller.app"

            zap trash: [
              "~/Library/Preferences/com.productdevbook.PortKiller.plist",
              "~/Library/Caches/com.productdevbook.PortKiller",
            ]
          end
          EOF

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/portkiller.rb
          git commit -m "Update portkiller to ${VERSION}"
          git push

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore platforms/windows/PortKiller/PortKiller.csproj

      - name: Build and publish x64
        run: |
          dotnet publish platforms/windows/PortKiller/PortKiller.csproj `
            -c Release `
            -r win-x64 `
            --self-contained false `
            -o publish/win-x64

      - name: Build and publish arm64
        run: |
          dotnet publish platforms/windows/PortKiller/PortKiller.csproj `
            -c Release `
            -r win-arm64 `
            --self-contained false `
            -o publish/win-arm64

      - name: Create ZIP archives
        run: |
          $version = "${{ github.ref_name }}"

          # Create x64 ZIP
          Compress-Archive -Path publish/win-x64/* -DestinationPath "PortKiller-${version}-windows-x64.zip"

          # Create arm64 ZIP
          Compress-Archive -Path publish/win-arm64/* -DestinationPath "PortKiller-${version}-windows-arm64.zip"

      - name: Upload to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ github.ref_name }}"
          gh release upload $version "PortKiller-${version}-windows-x64.zip" --clobber
          gh release upload $version "PortKiller-${version}-windows-arm64.zip" --clobber
